# 3 Exploratory data analysis

```{r, echo = FALSE, message = FALSE}
source(here::here("scripts/setup.R"))
```
__TO DO's__

* Mapping out the underlying structure
* Identifying the most important variables
* Univariate visualizations
* Multivariate visualizations
* Summary tables

## 3.1 Univariate Visualizations
### 3.1.1 sesonality
```{r}
# Filter for only Passenger car vehicle type
passenger_cars <- df_v |>
  filter(VehicleType == "Passenger car") |>
  group_by(Date) %>%
  summarise(Count = sum(Count, na.rm = TRUE), .groups = 'drop')

# Plotting the data with ggplot2, using Date directly for Passenger cars
ggplot(passenger_cars, aes(x = Date, y = Count)) +
  geom_line() + # Use geom_bar(stat = "identity") if you prefer bar plots
  labs(title = "Passenger Car Adoption Over Time",
       x = "Date",
       y = "Number of Passenger Cars Registered") +
  theme_minimal() +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") + 
  geom_smooth(method = "loess", se = FALSE, color = "blue") +# Set date breaks and labels
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels by 45 degrees

```
* seasonality

```{r}
# Filter for only Passenger car vehicle type
passenger_cars <- df_v %>%
  filter(VehicleType == "Passenger car") |>
  mutate(Year = year(Date), Month = month(Date)) |>
  group_by(Year, Month) %>%
  summarise(Count = sum(Count, na.rm = TRUE), .groups = 'drop') |>
  mutate(Month = factor(Month, levels = 1:12, labels = month.name))  # Convert Month to a factor to ensure proper ordering in the plot

# Plotting the data with ggplot2, showing the trend within each year
ggplot(passenger_cars, aes(x = Month, y = Count, group = Year, color = as.factor(Year))) +
  geom_line(stat = "smooth", se = FALSE, method = "loess", span = 0.5) +  # Smooth the existing lines
  labs(title = "Monthly Passenger Car Registrations by Year",
       x = "Month",
       y = "Number of Passenger Cars Registered") +
  theme_minimal() +
  scale_x_discrete(limits = month.name) +  # Ensure months are shown in order
  scale_color_viridis_d() +  # Use viridis color scale
  theme(legend.position = "bottom", axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels by 45 degrees)

```

* This pattern suggests a seasonal trend with a mid-year peak and a year-end increase.
*2020 covid year ?

```{r}
# Filter for only Passenger car vehicle type
passenger_cars <- df_v |>
  filter(VehicleType == "Passenger car") |>
  mutate(YearMonth = floor_date(Date, "month")) |>
  group_by(YearMonth) %>%
  summarise(Count = sum(Count, na.rm = TRUE), .groups = 'drop') |>
  ungroup() %>%
  mutate(Year = year(YearMonth), 
         Month = month(YearMonth, label = TRUE, abbr = TRUE)) |>
  arrange(Year, Month)

# Plotting the data with ggplot2 without month names on the x-axis
ggplot(passenger_cars, aes(x = as.numeric(format(YearMonth, "%m")), y = Count, group = Year, color = as.factor(Year))) +
  geom_line() +
  facet_wrap(~ Year, scales = "free_y") +
  labs(title = "Seasonal Trends in Passenger Car Registrations",
       x = "Month",
       y = "Number of Passenger Cars Registered") +
  theme_minimal() +
  theme(axis.text.x = element_blank(), # This will remove the month labels
        axis.text.y = element_blank(), # This will remove the month labels
        axis.ticks.x = element_blank(), # This will remove the ticks on the x-axis
        legend.position = "none") # Remove the legend to clean up the plot
```

### 3.1.2

```{r}
# Filter df_v for specific fuel types and vehicle type
filtered_df <- df_v %>%
  filter(Fuel %in% c("Petrol", "Diesel", "Conventional hybrid", "Plug-in hybrid", "Electricity") &
         VehicleType == "Passenger car")

# Group by Date and Fuel type, and summarize the count
fuel_type_trends <- filtered_df %>%
  group_by(Date, Fuel) %>%
  summarize(Count = sum(Count, na.rm = TRUE)) %>%
  ungroup()

# Plotting the trends over time by fuel type
ggplot(fuel_type_trends, aes(x = Date, y = Count, color = Fuel)) +
  geom_line(stat = "smooth", se = FALSE, method = "loess", span = 0.1, size = 1) +
  labs(title = "Vehicle Registrations by Fuel Type Over Time",
       x = "Date",
       y = "Number of Vehicles Registered") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

*merge diesel and Petrol ?

# 3.1.3 Proportion par cantons
```{r}
filter_for_canton <- df_v[df_v$VehicleType == "Passenger car" & 
                      df_v$Fuel %in% c("Petrol", "Diesel", "Conventional hybrid", "Plug-in hybrid", "Electricity") & 
                      !(df_v$Location %in% c("Switzerland", "Confederation")), ]

# Plotting
ggplot(filter_for_canton, aes(x = Location, fill = Fuel)) +
  geom_bar(position = "fill") +
  labs(title = "Count of Passenger Cars by Fuel Type in Swiss Cantons",
       x = "Swiss Cantons",
       y = "Count") +
  scale_fill_manual(values = c("Petrol" = "blue", "Diesel" = "green", "Conventional hybrid" = "orange", 
                                "Plug-in hybrid" = "red", "Electricity" = "purple")) +
  theme_minimal()
```


## 3.2 Google Trend
```{r}
ggplot(df_gtrends, aes(x = Date, y = SearchRatio)) +
  geom_line(color = "darkgreen", size = 1, stat='smooth', se = FALSE, method = "loess", span = 0.1, size = 1) +
  labs(x = "Date", y = "Google Search", title = "Google search About EV in Switzerland")
```

## 3.3 Oil
```{r}
ggplot(oil_df, aes(x = Date , y = Price)) +
  geom_line(color = "darkred", size = 1) +
  labs(x = "Date", y = "Price", title = "Oil Price Over Time")
```
## 3.4 Demographics
```{r}
demographic_data <- df_demographic %>%
  mutate(Population = `Generation Z` + `Millenials` + `Generation X` + `Baby Boomers`)

# Plotting the data
ggplot(demographic_data, aes(x = Year)) +
  geom_line(aes(y = `Generation Z`, color = "Generation Z"), size = 1) +
  geom_line(aes(y = Millenials, color = "Millenials"), size = 1) +
  geom_line(aes(y = `Generation X`, color = "Generation X"), size = 1) +
  geom_line(aes(y = `Baby Boomers`, color = "Baby Boomers"), size = 1) +
  labs(title = "Demographic Trends in Switzerland",
       x = "Year",
       y = "Population",
       color = "Generation") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  scale_color_manual(values = c("Generation Z" = "blue", "Millenials" = "red", "Generation X" = "green", "Baby Boomers" = "purple"))

```
## 3.5 French vehicles
# 3.5.1 Total vehicules evolution
```{r}
# Preparing for plotting
long_df_v_fr <- pivot_longer(df_v_fr[, c("Year", "Diesel", "Essence", "Conventional_Hybrid", "Plug_in_Hybrid", "Electrique")],
                             cols = -Year,
                             names_to = "Category",
                             values_to = "Value")

# plotting
ggplot(long_df_v_fr, aes(x = Year, y = Value, color = Category)) +
  geom_line(size = 1) +
  labs(title = "Log Scale - Evolution of cars registered in France over the years by fuel type",
       x = "Years",
       y = "Logarithmic Scale of Value",
       color = "Fuel Category") +
  theme_minimal() +
  scale_y_log10()

```
# 3.5.2 Deltas evolution
```{r}
# Preparing total parc plotting (without the deltas)
long_delta_df_V_fr <- pivot_longer(df_v_fr[,c("Year",
                                              "Diesel_delta",
                                              "Essence_delta",
                                              "Conventional_Hybrid_delta",
                                              "Plug_in_Hybrid_delta",
                                              "Electrique_delta")],
                                   cols = -Year,
                                   names_to = "Category",
                                   values_to = "Value")

# plotting for total cars
ggplot(long_delta_df_V_fr, aes(x = Year, y = Value, color = Category)) +
  geom_line(size = 1) +
  labs(title = "Evolution of cars registered in France over the years by fuel type",
       x = "Years",
       y = "Value",
       color = "Fuel Category") +
  theme_minimal() +
  scale_y_continuous(labels = scales::label_number())
```


## 3.2 Multivariate visualizations
Combined analysis

### 3.2.1 Swiss vs France
#### Electric
```{r}
# Filtering Swiss data for Passenger cars
swiss_passenger_electric <- df_v %>%
  filter(Fuel == "Electricity") |>
  filter(VehicleType == 'Passenger car') |>
  filter(Location == 'Switzerland')

# Plotting Swiss Passenger vs Electric cars and French Electrique data
ggplot() +
  geom_line(data = swiss_passenger_electric, aes(x = Date, y = Count, color = VehicleType))  +
  geom_line(data = df_v_fr, aes(x = Date, y = Electrique, color = "French Electrique")) +
  labs(x = "Date/Year", y = "Count", color = "Vehicle Type") +
  theme_minimal()
```
#### Electric, Hybrid, Petrol
```{r}
unique(df_v$Fuel)
# Filtering Swiss data for specific fuel types
swiss_specific_fuel <- df_v %>%
  filter(Fuel %in% c("Diesel", "Electricity", "Conventional hybrid", "Plug-in hybrid", "Petrol")) %>%
  filter(Location == 'Switzerland') |>
  filter(VehicleType == 'Passenger car') |>
  filter(Date > as.Date('2012-01-01'))

# Selecting equivalent columns from the French dataset
french_specific_fuel <- df_v_fr %>%
  select(Date, Diesel_delta, Essence_delta, Conventional_Hybrid_delta, Plug_in_Hybrid_delta, Electrique_delta) # Adjust column names accordingly

# Reshape French dataset to long format for easier plotting
french_specific_fuel_long <- french_specific_fuel %>%
  pivot_longer(cols = -Date, names_to = "Fuel", values_to = "Count")

# Standardize counts in each dataset
swiss_specific_fuel <- swiss_specific_fuel %>%
  mutate(Count = scale(Count))

french_specific_fuel_long <- french_specific_fuel_long %>%
  mutate(Count = scale(Count))

# Rename the 'Fuel' column in the French dataset
french_specific_fuel_long <- french_specific_fuel_long %>%
  mutate(Fuel = case_when(
    Fuel == "Diesel_delta" ~ "Diesel",
    Fuel == "Essence_delta" ~ "Petrol",
    Fuel == "Conventional_Hybrid_delta" ~ "Conventional hybrid",
    Fuel == "Plug_in_Hybrid_delta" ~ "Plug-in hybrid",
    Fuel == "Electrique_delta" ~ "Electricity"
  ))

unique(swiss_specific_fuel$Fuel)
# Define color palette for each fuel type
fuel_colors <- c("Diesel" = "red", "Electricity" = "blue", "Conventional hybrid" = "green", "Plug-in hybrid" = "purple", "Petrol" = "black")

# Plotting
ggplot() +
  geom_smooth(data = swiss_specific_fuel, aes(x = Date, y = Count, color = Fuel), method = "loess", se = FALSE, size = 1.5) +
  geom_line(data = french_specific_fuel_long, aes(x = Date, y = Count, color = Fuel), alpha = 0.5, size = 1.5) +
  scale_color_manual(values = fuel_colors, labels = c("Diesel", "Electricity", "Conventional hybrid", "Plug-in hybrid"),
                     breaks = c("Diesel", "Electricity", "Conventional hybrid", "Plug-in hybrid")) +
  labs(x = "Date", y = "Standardized Count", color = "Fuel Type") +
  theme_minimal() +
  geom_text(data = data.frame(x = as.Date("2014-01-01"), y = c(1, 0.5), label = c("Switzerland", "France")), 
            aes(x = x, y = y, label = label, color = label), size = 5, show.legend = FALSE)
```

